# 技术调研

## 物流查询

### 功能现状
- 小程序订单详情支持展示快递公司与单号，并在“已发货”时自动拉取物流轨迹并展示。
- 展示与交互：`litemall-wx/pages/ucenter/orderDetail/orderDetail.wxml:83-96`
- 订单详情返回快递公司、单号与轨迹：`litemall-wx-api/src/main/java/org/linlinjava/litemall/wx/service/WxOrderService.java:205-229`
- 物流查询服务对接快递鸟（Kdniao）：`litemall-core/src/main/java/org/linlinjava/litemall/core/express/ExpressService.java:63-79`、`86-102`

### 当前问题
- 后端配置未开启物流查询：`litemall.express.enable=false`，导致查询被直接跳过并返回空轨迹。
  - 配置位置（示例）：`litemall-core/src/main/resources/application-core.yml:53-58`、`deploy/litemall/application.yml:87-91`
- 未配置快递鸟 `appId/appKey`，无法进行外部查询。
- 独立的调试接口 `/wx/express/query` 在当前代码库未实现（前端 API 常量已预留）：`litemall-wx/config/api.js:65`
- 单号格式可能不规范（例如包含短横线），会导致快递鸟查询失败或异常。

### 需要做的事情
- 在后端配置中开启物流查询并填入有效的快递鸟凭证：
  - 将 `litemall.express.enable` 置为 `true`。
  - 配置 `appId` 与 `appKey`。
  - 参考：`deploy/litemall/application.yml:86-97`、`litemall-core/src/main/resources/application-core.yml:53-65`。
- 发货时设置正确的快递编码与单号：
  - 例如韵达使用编码 `YD`（供应商列表含 `YD`）：`litemall-core/src/main/resources/application-core.yml:63-65`。
  - 单号建议去除分隔符（如将 `250921-047490025062643` 处理为 `250921047490025062643`）。
  - 管理后台发货接口入参：`shipChannel` 与 `shipSn`（参考 Admin 服务发货逻辑）。
- 重启后端服务以应用配置。
- 可选：新增仅用于调试的接口 `/wx/express/query`（参数 `expCode`、`expNo`），直接返回轨迹以便独立验证。
- 可选：小程序在 `expressInfo` 为空时给出提示或重试策略，提升用户体验。

### 实现细节参考
- 小程序订单详情页面：
  - 显示快递公司与单号：`litemall-wx/pages/ucenter/orderDetail/orderDetail.wxml:86-88`
  - 展开物流轨迹列表（`Traces`）：`litemall-wx/pages/ucenter/orderDetail/orderDetail.wxml:91-96`
  - 展开/收起逻辑：`litemall-wx/pages/ucenter/orderDetail/orderDetail.js:26-31`
  - 数据来源设置：`litemall-wx/pages/ucenter/orderDetail/orderDetail.js:41-53`
- 后端订单详情聚合：
  - 返回 `expCode/expName/expNo`：`litemall-wx-api/src/main/java/org/linlinjava/litemall/wx/service/WxOrderService.java:205-208`
  - “已发货”时查询轨迹：`litemall-wx-api/src/main/java/org/linlinjava/litemall/wx/service/WxOrderService.java:217-224`
- 物流服务调用快递鸟：
  - 关闭时返回 `null`：`litemall-core/src/main/java/org/linlinjava/litemall/core/express/ExpressService.java:63-79`
  - 构造与发送请求：`litemall-core/src/main/java/org/linlinjava/litemall/core/express/ExpressService.java:86-102`
- 供应商编码与名称映射：`litemall-core/src/main/java/org/linlinjava/litemall/core/express/ExpressService.java:44-55`，配置列表：`litemall-core/src/main/resources/application-core.yml:59-85`

### 风险与注意事项
- 快递鸟账号的配额与计费需确认，避免上线后被限流。
- 快递编码需与配置一致（例如韵达为 `YD`），避免编码错误导致查询失败。
- 单号需规范化（去除空格、分隔符），减少查询失败概率。
- 非“已发货”状态不会查询轨迹，页面不展示轨迹属预期行为。
- 网络与第三方可用性：需要超时与失败兜底策略。

### 验证步骤
- 管理后台对一个已支付订单执行“发货”，设置：`shipChannel=YD`、`shipSn=250921047490025062643`。
- 打开小程序订单详情，展开“物流轨迹”，应看到 `Traces` 列表。
- 若无轨迹：检查开关与凭证、供应商编码是否正确、单号格式是否规范、订单是否处于“已发货”。

### 结论
- 开启并配置物流查询后，系统可以展示完整的物流轨迹；当前因开关关闭与凭证未配置，页面只展示快递公司与单号而不显示轨迹。
