# 微信支付费用与配置说明

**适用范围**
- 小程序 JSAPI 支付与 H5/MWEB 支付
- 项目内涉及的“预支付参数获取、微信回调、管理员退款”等接口

**是否需要付费**
- 微信支付交易手续费：按照微信官方计费规则按笔收取手续费（费率由商户所属行业与签约情况确定）。调用支付接口本身不单独计费，但每笔交易产生手续费。
- 短信通知费用：若开启短信通知（支付成功/退款成功等），由所选短信渠道（腾讯云或阿里云）按条计费。
- 域名与证书：生产环境需要可公网访问的域名与 HTTPS 证书（证书费用由你们的证书供应商决定）。

**必要配置（服务端）**
- 基本参数：`appId/mchId/mchKey/notifyUrl/keyPath`
  - 配置文件：`litemall-core/src/main/resources/application-core.yml:1-20`、`docker/litemall/application.yml:23-44`
  - Bean 装配：`litemall-core/src/main/java/org/linlinjava/litemall/core/config/WxConfig.java:37-56`
- 回调地址：需在微信商户平台或代码中设置为可公网访问的地址，项目默认示例为 `.../wx/order/pay-notify`
  - 控制器回调入口：`litemall-wx-api/src/main/java/org/linlinjava/litemall/wx/web/WxOrderController.java:125-128`
  - 回调处理逻辑：`litemall-wx-api/src/main/java/org/linlinjava/litemall/wx/service/WxOrderService.java:723-839`
- 商户证书（`keyPath`）：
  - 退款等敏感接口需要加载商户证书；在 `WxConfig` 中通过 `payConfig.setKeyPath(...)` 配置
  - 配置示例：`litemall-core/src/main/resources/application-core.yml:10-16`

**必要配置（微信侧）**
- 开通微信支付商户号并完成签约、绑定小程序 `AppID`
- 配置支付授权目录、回调通知地址、业务域名（JSAPI 与 MWEB/H5 支付分别要求）
- 开通退款权限并在商户平台上传 API 证书

**项目中的接口与配置位置**
- 预支付（JSAPI）：
  - 调用入口：`/wx/order/prepay`，控制器 `litemall-wx-api/.../WxOrderController.java:97-100`
  - 业务实现：`litemall-wx-api/.../WxOrderService.java:604-667`
- H5 支付（MWEB）：
  - 调用入口：`/wx/order/h5pay`，控制器 `litemall-wx-api/.../WxOrderController.java:110-113`
  - 业务实现：`litemall-wx-api/.../WxOrderService.java:669-721`
- 回调处理：
  - 调用入口：`/wx/order/pay-notify`，控制器 `litemall-wx-api/.../WxOrderController.java:125-128`
  - 业务实现：`litemall-wx-api/.../WxOrderService.java:723-839`
- 管理员退款：
  - 控制器：`litemall-admin-api/src/main/java/org/linlinjava/litemall/admin/web/AdminOrderController.java:95-106`
  - 业务实现（微信退款 API）：`litemall-admin-api/src/main/java/org/linlinjava/litemall/admin/service/AdminOrderService.java:92-182`

**端到端简要流程（JSAPI）**
```mermaid
flowchart TD
  A[小程序 /wx/order/submit] --> B{是否已付}
  B -- 否 --> C[/wx/order/prepay]
  C --> D[WxPayService.createOrder(JSAPI)]
  D --> E[wx.requestPayment]
  E -- 成功 --> F[/wx/order/pay-notify]
  F --> G[校验金额与状态, 更新为已支付]
  G --> H[短信通知与任务清理]
  B -- 是 --> I[支付成功页]
```

**常见问题与上线清单**
- 必须项：`appId/mchId/mchKey/notifyUrl` 正确、回调地址可公网访问、JSAPI/H5 业务域名已配置、API 证书已上传（退款必需）。
- 金额校验：服务端按“分→元”比对实付金额，若不一致回调失败；参考 `litemall-wx-api/src/main/java/org/linlinjava/litemall/wx/service/WxOrderService.java:756-778`。
- `openid` 缺失：小程序端需先完成微信登录获取 `openid`；否则拒付；参考 `litemall-wx-api/.../WxOrderService.java:641-651`。
- 短信费用：根据 `litemall.notify.sms` 的启用与渠道配置计费；参考 `litemall-core/src/main/resources/application-core.yml:18-45`、`docker/litemall/application.yml:61-90`。
- 退款证书：管理员退款走微信退款 API，需要 `keyPath` 指向商户证书；参考 `AdminOrderService.java:117-129` 与 `WxConfig.java:37-47`。

**结论**
- 调用微信支付相关 API 本身不额外计费，但每笔交易按官方费率收取手续费；短信通知与证书等为外部资源成本。
- 上线前请确保业务域名、回调地址、商户证书与密钥配置齐备，并在微信商户平台完成授权目录与权限开通。
