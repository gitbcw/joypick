## 目标
- 为至少一条订单保存真实的快递轨迹快照，供演示稳定展示。
- 订单详情优先读取快照；无快照或过期时实时查询并更新快照。

## 关键挂接点
- 小程序订单详情触发查询位置：`litemall-wx-api/src/main/java/org/linlinjava/litemall/wx/service/WxOrderService.java:221-235`
- 管理端便捷查询位置：`litemall-admin-api/src/main/java/org/linlinjava/litemall/admin/web/AdminOrderController.java:76-80`
- 第三方查询服务：`litemall-core/src/main/java/org/linlinjava/litemall/core/express/ExpressService.java:67-83, 90-120`
- 订单持久化字段（仅公司+单号）：`litemall-db/src/main/resources/org/linlinjava/litemall/db/dao/LitemallOrderMapper.xml:114,242-243,593-594,733-734`

## 数据表设计
- 新增表：`litemall_order_express`
  - 字段：`id, order_id, exp_code, exp_no, vendor_name, customer_name_suffix, state, traces_json, query_time, updated`
  - 说明：`traces_json` 保存快递鸟返回的完整 JSON；`state` 保存当前快递状态码；`query_time` 首次快照时间；`updated` 最近更新时间。

## 服务与DAO
- 新增 `OrderExpress` 实体 + `OrderExpressMapper.xml`（插入、按 `order_id`/`exp_no` 查询、按主键更新）。
- 新增 `OrderExpressService`：
  - `getByOrderId(orderId)` 读取快照
  - `snapshot(orderId, expCode, expNo, customerNameSuffix, ExpressInfo)` 落库/更新

## 业务改造
- `WxOrderService.detail(...)`：
  - 先查 `OrderExpressService.getByOrderId(orderId)`；存在且未过期（例如 6 小时）则直接返回快照的 `traces_json` 反序列化为 `ExpressInfo`。
  - 否则调用 `expressService.getExpressInfo(...)`（已支持 `8002` 和尾号），成功后 `snapshot(...)` 落库再返回。
  - 参考挂接：`litemall-wx-api/.../WxOrderService.java:221-235`
- 管理端补充快照入口：
  - 新增 `POST /admin/order/express/snapshot`，入参：`orderId` 或 `expCode+expNo[+customerName]`；流程：调用 `expressService.getExpressInfo(...)` → `snapshot(...)` → 返回持久化结果。
  - 便于演示前预热与校验。

## 小程序展示
- 保持现有渲染：`orderDetail.wxml` 循环 `expressInfo.Traces`；来源将变为“快照优先，实时兜底”。
  - 现有赋值点：`litemall-wx/pages/ucenter/orderDetail/orderDetail.js:47-52`

## 演示准备
- 选择或创建一条 `STATUS_SHIP` 的订单，确保 `ship_channel/ship_sn` 已填。
- 使用管理端接口对该订单执行一次快照：
  - 示例：中通 `ZTO`，单号 `78963716282576`，尾号 `7221`（若该单号失效，可更换为您提供的在途单号）。

## 过期策略与容错
- 过期阈值：默认 6 小时（可配）；过期后请求第三方并更新快照。
- 容错：
  - 第三方失败时，若有旧快照，继续返回旧快照并标注“数据时间”以提示陈旧。
  - 特殊快递（如 `SF/JD`）需传条件字段；`8002` 已支持 `CustomerName` 尾号。

## 配置前置
- 确保环境变量启用：`KDN_ENABLE=true`、`KDN_APP_ID`、`KDN_APP_KEY`、`KDN_REQUEST_TYPE=8002`。
- 参考：`litemall-core/src/main/resources/application-core.yml`、`deploy/litemall/application.yml`

## 验证
- 管理端调用快照接口，返回成功并产生一条 `litemall_order_express` 记录。
- 打开小程序订单详情，确认轨迹展示稳定；断网或第三方不可用时仍可展示快照。
- 再次访问触发过期更新路径，验证快照刷新生效。

## 交付内容
- 新表 SQL 与迁移脚本
- 新增实体/Mapper/Service 与单元测试
- 控制器端点与订单详情改造
- 最少一条订单的真实轨迹快照（用于演示）
